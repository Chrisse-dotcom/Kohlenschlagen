<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kohlenschlagen ‚Äì digitaler Spielzettel</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#667085;
      --border:#e6e8ee;
      --shadow: 0 2px 12px rgba(16,24,40,.08);
      --radius: 16px;
      --pad: 14px;
      --brand:#111;
      --danger:#b91c1c;
      --soft:#f2f4f7;
      --soft2:#fafafa;
    }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:0;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding: 14px 16px;
      background:linear-gradient(180deg,#111,#0b0b0b);
      color:#fff;
      position: sticky;
      top: 0;
      z-index: 30;
      box-shadow: 0 2px 18px rgba(0,0,0,.12);
    }
    main{
      padding: 16px;
      max-width: 1040px;
      margin: 0 auto;
    }

    h2,h3,h4{ letter-spacing: -0.02em; }
    h2{ font-size: 22px; }
    h3{ font-size: 18px; }
    h4{ font-size: 15px; margin-bottom: 8px; }

    .card{
      background:var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    input, textarea, select, button{
      font-size: 16px;
      border-radius: 12px;
    }
    input, textarea, select{
      padding: 10px 12px;
      border: 1px solid var(--border);
      background:#fff;
      outline:none;
      width: 100%;
    }
    textarea{ min-height: 140px; }
    input:focus, textarea:focus, select:focus{
      border-color:#cbd5e1;
      box-shadow: 0 0 0 4px rgba(15,23,42,.08);
    }

    button{
      border:0;
      cursor:pointer;
      padding: 10px 12px;
      background: var(--brand);
      color:#fff;
      transition: transform .04s ease, opacity .15s ease, box-shadow .15s ease;
      box-shadow: 0 8px 16px rgba(0,0,0,.12);
      width: auto;
    }
    button:hover{ opacity:.95; }
    button:active{ transform: translateY(1px); }
    button.secondary{
      background: var(--soft);
      color: var(--text);
      box-shadow:none;
      border:1px solid var(--border);
    }
    button.danger{
      background: var(--danger);
      box-shadow: 0 8px 16px rgba(185,28,28,.18);
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
    }

    .muted{ color:var(--muted); }
    .small{ font-size: 13px; }

    .pill{
      display:inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      background: #eef2ff;
      border:1px solid #e0e7ff;
      font-size: 12px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
    }

    .check{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 12px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: var(--soft2);
    }
    .check input{ transform: scale(1.1); width:auto; }

    .teamTop{
      position: sticky;
      top: 56px;
      z-index: 20;
      backdrop-filter: blur(8px);
    }

    .segmented{
      display:inline-flex;
      padding: 4px;
      border-radius: 999px;
      background: var(--soft);
      border:1px solid var(--border);
    }
    .segmented button{
      padding: 8px 12px;
      border-radius: 999px;
      background: transparent;
      color: var(--muted);
      box-shadow:none;
      border:0;
    }
    .segmented button.active{
      background:#fff;
      color: var(--text);
      border:1px solid var(--border);
      box-shadow: 0 6px 16px rgba(16,24,40,.08);
    }

    .subtabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .subtabs button{
      box-shadow:none;
      border:1px solid var(--border);
    }
    .subtabs button.active{
      background:#fff;
      color: var(--text);
      box-shadow: 0 6px 16px rgba(16,24,40,.08);
    }

    table{ width:100%; border-collapse: collapse; }
    th, td{
      padding: 10px;
      border-bottom: 1px solid #f0f2f5;
      text-align:left;
      vertical-align: top;
    }
    th{ color:#475467; font-weight:600; font-size: 13px; }

    .kpi{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .kpi .box{
      background: #fbfbfc;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      min-width: 170px;
    }

    .warn{
      background:#fff7ed;
      border:1px solid #fed7aa;
      border-radius: 14px;
      padding: 12px;
    }

    .leaderRow{
      background: #f0f9ff;
      border:1px solid #bae6fd;
      border-radius: 14px;
    }

    .mobileOnly{ display:none; }
    .desktopOnly{ display:block; }

    @media (max-width: 760px){
      main{ padding: 12px; }
      .desktopOnly{ display:none; }
      .mobileOnly{ display:block; }
      .teamTop{ top: 54px; }

      .playerCard{
        border:1px solid var(--border);
        background:#fff;
        border-radius: 16px;
        padding: 12px;
        margin-bottom: 10px;
        box-shadow: 0 2px 10px rgba(16,24,40,.06);
      }
      .playerCard .top{
        display:flex;
        justify-content:space-between;
        align-items: baseline;
        gap:10px;
      }
      .playerCard .money{
        font-weight:700;
        font-size: 16px;
      }
      .playerCard .meta{
        margin-top: 6px;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.35;
      }
    }

    .w-auto{ width:auto; }
    .sectionCard{ background:#fbfbfc; }
    .field label{
      display:block;
      margin: 0 0 6px 2px;
      font-size: 13px;
      color: var(--muted);
    }
    .spacer{ height: 6px; }

    .dangerLink{
      background: transparent;
      border: 0;
      color: var(--danger);
      box-shadow:none;
      padding: 0;
      cursor: pointer;
      text-decoration: underline;
      font-size: 14px;
    }
  </style>
</head>

<body>
<header>
  <strong>Kohlenschlagen</strong> <span class="muted">‚Äì digitaler Spielzettel</span>
</header>

<main>
  <!-- START -->
  <div id="viewStart" class="card">
    <h2 style="margin-top:0;">Neues Team anlegen</h2>
    <div class="row">
      <input id="teamName" class="w-auto" style="flex:1; min-width: 220px;" placeholder="Teamname" />
      <button id="createTeamBtn" type="button">Team erstellen</button>
    </div>
    <p class="muted small" style="margin-bottom:0;">
      Teams bleiben im Browser gespeichert. Neues Spiel = neues Team.
    </p>
  </div>

  <!-- TEAM VIEW -->
  <div id="viewTeam" style="display:none;">
    <div class="card teamTop">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h2 id="teamTitle" style="margin:0;"></h2>
          <div class="muted small" id="teamMeta"></div>
        </div>

        <div class="segmented" role="tablist" aria-label="Ansicht w√§hlen">
          <button id="tabDashboard" class="active" type="button">Dashboard</button>
          <button id="tabGame" type="button">Spiel</button>
          <button id="tabOptions" type="button">Optionen</button>
        </div>
      </div>
    </div>

    <div id="panelDashboard" class="card"></div>
    <div id="panelGame" class="card" style="display:none;"></div>
    <div id="panelOptions" class="card" style="display:none;"></div>
  </div>

  <!-- TEAM LIST -->
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <h3 style="margin-top:0;margin-bottom:0;">Vorhandene Teams</h3>
      <button id="deleteAllTeamsBtn" class="secondary" type="button">Alle Teams l√∂schen</button>
    </div>
    <div class="spacer"></div>
    <div id="teamList" class="muted">‚Äî</div>
  </div>
</main>

<script>
(() => {
  "use strict";

  /** =======================
   *  Storage
   *  ======================= */
  const KEY = "kohlenschlagen_teams_v5_clean";

  function loadTeams(){
    try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch { return []; }
  }
  function saveTeams(teams){
    localStorage.setItem(KEY, JSON.stringify(teams));
  }

  /** =======================
   *  Helpers
   *  ======================= */
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function eur(n){
    const x = Math.round((Number(n) + Number.EPSILON) * 100) / 100;
    return x.toFixed(2).replace(".", ",") + " ‚Ç¨";
  }
  function nowStr(ts){ return new Date(ts).toLocaleString(); }

  function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

  /** =======================
   *  Model
   *  ======================= */
  function defaultTeam(name){
    return {
      teamId: uid(),
      teamName: name.trim(),
      createdAt: Date.now(),
      ended: false,
      config: {
        points: { stockditsch: 1, windditsch: 1, unterweite: 1 },
        money:  { kohleWeg: 1.00, heideKaputt: 1.00, stockKaputt: 1.00, pflichtschlag: 1.00 }
      },
      players: [],
      turn: { currentPlayerIndex: 0, round: 1 },
      history: []
    };
  }

  function blankPlayer(name){
    return {
      name: name.trim(),
      pointsTotal: 0,
      flags: { kohleWeg:false, heideKaputt:false, stockKaputt:false },

      // Pflicht (separat)
      pfAttempts: 0,
      pfFails: 0,
      pfDone: false,     // true wenn Erfolg oder 3 Versuche erreicht
      pfSuccess: false   // true wenn Erfolg
    };
  }

  function anyPlayersMissing(team){
    return !team.players || team.players.length === 0;
  }

  function calcTotals(team, p){
    const money = team.config.money;
    const pointsEuro = (p.pointsTotal || 0) * 0.01;

    const flags = p.flags || { kohleWeg:false, heideKaputt:false, stockKaputt:false };
    const eventsEuro =
      (flags.kohleWeg ? 1 : 0) * (Number(money.kohleWeg)||0) +
      (flags.heideKaputt ? 1 : 0) * (Number(money.heideKaputt)||0) +
      (flags.stockKaputt ? 1 : 0) * (Number(money.stockKaputt)||0);

    const pfCostEuro = (p.pfFails || 0) * (Number(money.pflichtschlag)||0);
    const totalEuro = pointsEuro + eventsEuro + pfCostEuro;

    return { pointsEuro, eventsEuro, pfCostEuro, totalEuro };
  }

  /** =======================
   *  App State
   *  ======================= */
  let teams = loadTeams();
  let activeTeamId = null;

  let activeTab = "dash";     // dash | game | opt
  let gameSubTab = "turn";    // turn | pflicht
  let pfSelectIndex = 0;      // selected player in pflicht view

  function getActiveTeam(){
    return teams.find(t => t.teamId === activeTeamId) || null;
  }

  function setActiveTeam(id){
    activeTeamId = id;
    document.getElementById("viewTeam").style.display = "block";
    activeTab = "dash";
    gameSubTab = "turn";
    pfSelectIndex = 0;
    renderAll();
  }

 function pushHistory(team){
  // Wichtig: Snapshot darf NICHT die History selbst enthalten, sonst bl√§st es sich auf.
  const snap = deepClone(team);
  snap.history = []; // oder: delete snap.history;
  team.history.push(snap);

  if (team.history.length > 120) team.history.shift();
}

  /** =======================
   *  Rendering
   *  ======================= */
  function renderTeamList(){
    const el = document.getElementById("teamList");
    if (!teams.length){
      el.textContent = "Keine Teams gespeichert.";
      return;
    }
    el.innerHTML = teams
      .slice()
      .sort((a,b)=>b.createdAt-a.createdAt)
      .map(t => {
        const ended = t.ended ? " <span class='pill'>beendet</span>" : "";
        return `
          <div style="padding:8px 0;">
            <button class="secondary" type="button" data-action="openTeam" data-id="${t.teamId}">√ñffnen</button>
            <strong style="margin-left:8px;">${escapeHtml(t.teamName)}</strong>${ended}
            <span class="muted small"> ‚Äì ${escapeHtml(nowStr(t.createdAt))}</span>
            <span class="muted small"> ‚Ä¢ </span>
            <button class="dangerLink" type="button" data-action="deleteTeam" data-id="${t.teamId}">l√∂schen</button>
          </div>
        `;
      }).join("");
  }

  function renderHeader(team){
    document.getElementById("teamTitle").textContent = team.teamName;

    const playersInfo = team.players.length
      ? `Spieler ${team.turn.currentPlayerIndex + 1}/${team.players.length}`
      : "Spieler ‚Äî";

    document.getElementById("teamMeta").textContent =
      `Runde ${team.turn.round} ‚Ä¢ ${playersInfo} ‚Ä¢ ${team.ended ? "beendet" : "l√§uft"} ‚Ä¢ erstellt ${nowStr(team.createdAt)}`;

    // Tabs active
    document.getElementById("tabDashboard").classList.toggle("active", activeTab==="dash");
    document.getElementById("tabGame").classList.toggle("active", activeTab==="game");
    document.getElementById("tabOptions").classList.toggle("active", activeTab==="opt");
  }

  function renderDashboard(team){
    const panel = document.getElementById("panelDashboard");

    panel.innerHTML = `
      <div class="row" style="justify-content:space-between;">
        <h3 style="margin:0;">Dashboard</h3>
        <div class="row">
          ${team.ended ? "" : `<button class="danger" type="button" data-action="endGame">Beenden</button>`}
        </div>
      </div>
      <p class="muted small">Sortierung: niedrigster Geldbetrag = Platz 1</p>
    `;

    if (anyPlayersMissing(team)){
      panel.innerHTML += `
        <div class="warn">
          <strong>Hinweis:</strong> Noch keine Spieler. Bitte unter <em>Optionen</em> Namen eintragen.
        </div>
      `;
      return;
    }

    const rows = team.players.map(p => ({ p, ...calcTotals(team,p) }))
      .sort((a,b)=>a.totalEuro-b.totalEuro);

    const leader = rows[0];
    panel.innerHTML += `
      <div class="kpi">
        <div class="box">
          <div class="muted small">Platz 1</div>
          <div><strong>${escapeHtml(leader.p.name)}</strong></div>
          <div class="small muted">${eur(leader.totalEuro)}</div>
        </div>
        <div class="box"><div class="muted small">Spieler</div><div><strong>${team.players.length}</strong></div></div>
        <div class="box"><div class="muted small">Runde</div><div><strong>${team.turn.round}</strong></div></div>
      </div>
      <div class="spacer"></div>
    `;

    const pfCostPerFail = Number(team.config.money.pflichtschlag) || 0;

    // Mobile cards
    panel.innerHTML += `
      <div class="mobileOnly">
        ${rows.map((r,i)=>{
          const f = r.p.flags;
          const remaining = Math.max(0, 3 - (r.p.pfAttempts||0));
          const status = r.p.pfDone ? "abgeschlossen" : "offen";
          const pfCost = (r.p.pfFails||0) * pfCostPerFail;
          return `
            <div class="playerCard ${i===0 ? "leaderRow" : ""}">
              <div class="top">
                <div><strong>#${i+1} ${escapeHtml(r.p.name)}</strong></div>
                <div class="money">${eur(r.totalEuro)}</div>
              </div>
              <div class="meta">
                Punkte: ${r.p.pointsTotal} (${eur(r.pointsEuro)})<br/>
                Pflicht: Versuche ${r.p.pfAttempts||0}/3 ‚Ä¢ Fehl ${r.p.pfFails||0} ‚Ä¢ Kosten ${eur(pfCost)} ‚Ä¢ ${status} (rest ${remaining})<br/>
                Kohle weg: ${f.kohleWeg ? "Ja" : "Nein"} ‚Ä¢ Heide kaputt: ${f.heideKaputt ? "Ja" : "Nein"} ‚Ä¢ Stock kaputt: ${f.stockKaputt ? "Ja" : "Nein"}
                (${eur(r.eventsEuro)})
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;

    // Desktop table
    panel.innerHTML += `
      <div class="desktopOnly">
        <table>
          <thead>
            <tr>
              <th>Platz</th>
              <th>Spieler</th>
              <th>Gesamt</th>
              <th>Punkte</th>
              <th>Pflichtstatus</th>
              <th>Ereignisse (je 1√ó/Spieler)</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map((r,i)=>{
              const f = r.p.flags;
              const remaining = Math.max(0, 3 - (r.p.pfAttempts||0));
              const status = r.p.pfDone ? "abgeschlossen" : "offen";
              const pfCost = (r.p.pfFails||0) * pfCostPerFail;
              return `
                <tr class="${i===0 ? "leaderRow" : ""}">
                  <td><strong>#${i+1}</strong></td>
                  <td>${escapeHtml(r.p.name)}</td>
                  <td><strong>${eur(r.totalEuro)}</strong></td>
                  <td>${r.p.pointsTotal} P <span class="muted small">(${eur(r.pointsEuro)})</span></td>
                  <td class="small muted">
                    Versuche: ${r.p.pfAttempts||0}/3 ‚Ä¢ Fehl: ${r.p.pfFails||0} ‚Ä¢ Kosten: ${eur(pfCost)} ‚Ä¢ ${status} ‚Ä¢ Rest: ${remaining}
                  </td>
                  <td class="small muted">
                    Kohle weg: ${f.kohleWeg ? "Ja" : "Nein"} ‚Ä¢
                    Heide kaputt: ${f.heideKaputt ? "Ja" : "Nein"} ‚Ä¢
                    Stock kaputt: ${f.stockKaputt ? "Ja" : "Nein"}
                    <span class="muted small">(${eur(r.eventsEuro)})</span>
                  </td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
    `;
  }

  function renderGame(team){
    const panel = document.getElementById("panelGame");

    if (team.ended){
      panel.innerHTML = `
        <h3 style="margin-top:0;">Spiel</h3>
        <p class="muted">Dieses Spiel ist beendet. Es ist nur noch das Dashboard sichtbar.</p>
      `;
      return;
    }

    if (anyPlayersMissing(team)){
      panel.innerHTML = `
        <h3 style="margin-top:0;">Spiel</h3>
        <p class="muted">Bitte zuerst Spieler unter Optionen anlegen.</p>
      `;
      return;
    }

    const current = team.players[team.turn.currentPlayerIndex];

    panel.innerHTML = `
      <div class="row" style="justify-content:space-between;">
        <div>
          <h3 style="margin:0;">Spiel</h3>
          <div class="muted small">
            Runde ${team.turn.round} ‚Ä¢ Aktuell: <strong>${escapeHtml(current.name)}</strong>
          </div>
        </div>
        <div class="row">
          <button class="secondary" type="button" data-action="undo">Undo</button>
          <button class="danger" type="button" data-action="endGame">Beenden</button>
        </div>
      </div>

      <div class="subtabs">
        <button class="secondary ${gameSubTab==="turn" ? "active" : ""}" type="button" data-action="setSubTab" data-sub="turn">Spielzug</button>
        <button class="secondary ${gameSubTab==="pflicht" ? "active" : ""}" type="button" data-action="setSubTab" data-sub="pflicht">Pflichtschl√§ge</button>
      </div>

      <div class="spacer"></div>
      <div id="gameSubContent"></div>
    `;

    const sub = panel.querySelector("#gameSubContent");
    sub.innerHTML = (gameSubTab==="pflicht") ? renderPflichtSub(team) : renderTurnSub(team);
  }

  function renderTurnSub(team){
    const p = team.players[team.turn.currentPlayerIndex];

    return `
      <div class="grid">
        <div class="check"><input type="checkbox" id="chk_stockditsch"> Stockditsch <span class="muted small">(+${team.config.points.stockditsch} P)</span></div>
        <div class="check"><input type="checkbox" id="chk_windditsch"> Windditsch <span class="muted small">(+${team.config.points.windditsch} P)</span></div>
        <div class="check"><input type="checkbox" id="chk_unterweite"> Unterweite <span class="muted small">(+${team.config.points.unterweite} P)</span></div>

        <div class="check">
          <input type="checkbox" id="chk_kohleWeg" ${p.flags.kohleWeg ? "checked disabled" : ""}>
          Kohle weg <span class="muted small">(+${eur(team.config.money.kohleWeg)})</span>
        </div>
        <div class="check">
          <input type="checkbox" id="chk_heideKaputt" ${p.flags.heideKaputt ? "checked disabled" : ""}>
          Heide kaputt <span class="muted small">(+${eur(team.config.money.heideKaputt)})</span>
        </div>
        <div class="check">
          <input type="checkbox" id="chk_stockKaputt" ${p.flags.stockKaputt ? "checked disabled" : ""}>
          Stock kaputt <span class="muted small">(+${eur(team.config.money.stockKaputt)})</span>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button type="button" data-action="nextTurn">Weiter</button>
        <span class="muted small">Du kannst auch nichts ausw√§hlen und einfach ‚ÄûWeiter‚Äú dr√ºcken. Runden sind unbegrenzt.</span>
      </div>
    `;
  }

  function renderPflichtSub(team){
    if (pfSelectIndex < 0 || pfSelectIndex >= team.players.length){
      pfSelectIndex = team.turn.currentPlayerIndex;
    }

    const p = team.players[pfSelectIndex];
    const attempts = p.pfAttempts || 0;
    const fails = p.pfFails || 0;
    const remaining = Math.max(0, 3 - attempts);
    const status = p.pfDone ? "abgeschlossen" : "offen";
    const costPerFail = Number(team.config.money.pflichtschlag) || 0;
    const costSoFar = fails * costPerFail;

    const disabled = p.pfDone || remaining === 0;

    return `
      <div class="card sectionCard" style="margin-bottom:0;">
        <h4 style="margin-top:0;">Pflichtschl√§ge (separat)</h4>
        <p class="muted small" style="margin-top:6px;">
          Jeder Spieler hat <strong>max. 3 Versuche</strong>.
          <br><strong>Erfolg</strong> beendet Pflicht sofort.
          <br>Nur <strong>Fehlversuche</strong> kosten: <strong>${eur(costPerFail)}</strong> je Fehlversuch.
        </p>

        <div class="grid">
          <div class="field">
            <label>Spieler ausw√§hlen</label>
            <select id="pflichtPlayerSelect">
              ${team.players.map((x,i)=>{
                const tag = x.pfDone ? " (fertig)" : "";
                return `<option value="${i}" ${i===pfSelectIndex ? "selected" : ""}>${escapeHtml(x.name)}${tag}</option>`;
              }).join("")}
            </select>
          </div>

          <div class="field">
            <label>Status</label>
            <div class="check" style="background:#fff;">
              <div>
                <div><strong>${escapeHtml(p.name)}</strong></div>
                <div class="small muted">Status: ${status}</div>
                <div class="small muted">Versuche: ${attempts}/3 ‚Ä¢ Fehlversuche: ${fails} ‚Ä¢ Verbleibend: ${remaining}</div>
                <div class="small muted">Kosten bisher: ${eur(costSoFar)}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="secondary" type="button" data-action="pflichtFail" ${disabled ? "disabled" : ""}>Fehlversuch</button>
          <button type="button" data-action="pflichtSuccess" ${disabled ? "disabled" : ""}>Erfolgreich</button>
          <button class="secondary" type="button" data-action="pflichtReset">Pflicht zur√ºcksetzen</button>
        </div>

        <p class="muted small" style="margin-bottom:0;">
          Hinweis: Wenn 3 Versuche erreicht sind, wird Pflicht automatisch als abgeschlossen markiert.
        </p>
      </div>
    `;
  }

  function renderOptions(team){
    const panel = document.getElementById("panelOptions");
    const names = team.players.map(p => p.name).join("\n");

    panel.innerHTML = `
      <h3 style="margin-top:0;">Optionen</h3>

      <div class="card sectionCard">
        <h4>üë• Spieler</h4>
        <p class="muted small">Ein Name pro Zeile, maximal 10 Spieler.</p>
        <textarea id="playerNames" rows="6">${escapeHtml(names)}</textarea>
        <div class="row" style="margin-top:8px;">
          <button type="button" data-action="savePlayers">Spieler speichern</button>
          <button class="secondary" type="button" data-action="resetTeam">Team zur√ºcksetzen</button>
        </div>
      </div>

      <div class="card sectionCard">
        <h4>üèÅ Punktdefinitionen</h4>
        <p class="muted small">
          Diese Punkte werden w√§hrend des Spiels gesammelt. <strong>1 Punkt = 1 Cent</strong> im Dashboard.
        </p>

        <div class="grid">
          <div class="field">
            <label>Punktzahl f√ºr Stockditsch</label>
            <input id="p_stockditsch" type="number" min="0" value="${team.config.points.stockditsch}" />
          </div>
          <div class="field">
            <label>Punktzahl f√ºr Windditsch</label>
            <input id="p_windditsch" type="number" min="0" value="${team.config.points.windditsch}" />
          </div>
          <div class="field">
            <label>Punktzahl f√ºr Unterweite</label>
            <input id="p_unterweite" type="number" min="0" value="${team.config.points.unterweite}" />
          </div>
        </div>
      </div>

      <div class="card sectionCard">
        <h4>üí∞ Geldbetr√§ge (fix)</h4>
        <p class="muted small">
          Diese Betr√§ge werden direkt in Euro berechnet.
          Kohle / Heide / Stock k√∂nnen je Spieler <strong>nur einmal</strong> auftreten.
          Pflichtschl√§ge laufen separat: <strong>max. 3 Versuche</strong>, Kosten nur bei <strong>Fehlversuch</strong>.
        </p>

        <div class="grid">
          <div class="field">
            <label>Geldbetrag in Euro f√ºr Kohle weg</label>
            <input id="m_kohleWeg" type="number" step="0.01" min="0" value="${team.config.money.kohleWeg}" />
          </div>
          <div class="field">
            <label>Geldbetrag in Euro f√ºr Heide kaputt</label>
            <input id="m_heideKaputt" type="number" step="0.01" min="0" value="${team.config.money.heideKaputt}" />
          </div>
          <div class="field">
            <label>Geldbetrag in Euro f√ºr Stock kaputt</label>
            <input id="m_stockKaputt" type="number" step="0.01" min="0" value="${team.config.money.stockKaputt}" />
          </div>
          <div class="field">
            <label>Geldbetrag in Euro f√ºr Pflichtschlag (je Fehlversuch)</label>
            <input id="m_pflicht" type="number" step="0.01" min="0" value="${team.config.money.pflichtschlag}" />
          </div>
        </div>
      </div>

      <div class="row">
        <button type="button" data-action="saveConfig">Optionen speichern</button>
      </div>

      <p class="muted small" style="margin-top:10px;">
        Regel√ºbersicht: Punkte ‚Üí Cent ‚Ä¢ Pflicht separat (max. 3 Versuche, Kosten nur bei Fehlversuch) ‚Ä¢ Kohle/Heide/Stock ‚Üí max. 1√ó je Spieler
      </p>
    `;
  }

  function showPanels(){
    const team = getActiveTeam();
    const dash = document.getElementById("panelDashboard");
    const game = document.getElementById("panelGame");
    const opt  = document.getElementById("panelOptions");

    dash.style.display = (activeTab==="dash") ? "block" : "none";
    game.style.display = (activeTab==="game") ? "block" : "none";
    opt.style.display  = (activeTab==="opt")  ? "block" : "none";

    if (team?.ended && activeTab==="game"){
      activeTab = "dash";
      dash.style.display = "block";
      game.style.display = "none";
    }
  }

  function renderAll(){
    teams = loadTeams();
    renderTeamList();

    const team = getActiveTeam();
    if (!team) return;

    renderHeader(team);
    showPanels();

    renderDashboard(team);
    renderGame(team);
    renderOptions(team);
  }

  /** =======================
   *  Actions
   *  ======================= */
  function persist(){
    saveTeams(teams);
  }

  function getTeamById(id){
    return teams.find(t => t.teamId === id) || null;
  }

  function ensurePfAutoDone(p){
    if ((p.pfAttempts||0) >= 3){
      p.pfDone = true;
      if (!p.pfSuccess) p.pfSuccess = false;
    }
  }

  function doNextTurn(team){
    pushHistory(team);

    const p = team.players[team.turn.currentPlayerIndex];

    const chk = (id) => document.getElementById(id)?.checked;

    if (chk("chk_stockditsch")) p.pointsTotal += Number(team.config.points.stockditsch)||0;
    if (chk("chk_windditsch"))  p.pointsTotal += Number(team.config.points.windditsch)||0;
    if (chk("chk_unterweite"))  p.pointsTotal += Number(team.config.points.unterweite)||0;

    if (chk("chk_kohleWeg"))    p.flags.kohleWeg = true;
    if (chk("chk_heideKaputt")) p.flags.heideKaputt = true;
    if (chk("chk_stockKaputt")) p.flags.stockKaputt = true;

    // Rotation (unbegrenzt)
    team.turn.currentPlayerIndex += 1;
    if (team.turn.currentPlayerIndex >= team.players.length){
      team.turn.currentPlayerIndex = 0;
      team.turn.round += 1;
    }

    persist();
    // Nach Weiter zur√ºck zu Spielzug
    gameSubTab = "turn";
    renderAll();
  }

  function doUndo(team){
    if (!team.history || team.history.length === 0){
      alert("Nichts zum R√ºckg√§ngig machen.");
      return;
    }
    const prev = team.history.pop();
    const idx = teams.findIndex(t => t.teamId === team.teamId);
    teams[idx] = prev;
    persist();
    renderAll();
  }

  function doEndGame(team){
    if (team.ended) return;
    if (!confirm("Wirklich beenden? Danach ist nur noch das Dashboard sichtbar.")) return;
    team.ended = true;
    persist();
    activeTab = "dash";
    renderAll();
  }

  function doSavePlayers(team){
    const raw = document.getElementById("playerNames").value || "";
    const list = raw.split("\n").map(s=>s.trim()).filter(Boolean);

    if (list.length > 10) return alert("Maximal 10 Spieler erlaubt.");
    if (list.length === 0) return alert("Bitte mindestens 1 Spieler eintragen.");

    pushHistory(team);

    team.players = list.map(n => blankPlayer(n));
    team.turn.currentPlayerIndex = 0;
    team.turn.round = 1;
    team.ended = false;
    team.history = [];

    gameSubTab = "turn";
    pfSelectIndex = 0;

    persist();
    renderAll();
    alert("Spieler gespeichert.");
  }

  function doSaveConfig(team){
    pushHistory(team);

    team.config.points.stockditsch = Number(document.getElementById("p_stockditsch").value || 0);
    team.config.points.windditsch  = Number(document.getElementById("p_windditsch").value || 0);
    team.config.points.unterweite  = Number(document.getElementById("p_unterweite").value || 0);

    team.config.money.kohleWeg      = Number(document.getElementById("m_kohleWeg").value || 0);
    team.config.money.heideKaputt   = Number(document.getElementById("m_heideKaputt").value || 0);
    team.config.money.stockKaputt   = Number(document.getElementById("m_stockKaputt").value || 0);
    team.config.money.pflichtschlag = Number(document.getElementById("m_pflicht").value || 0);

    persist();
    renderAll();
    alert("Optionen gespeichert.");
  }

  function doResetTeam(team){
    if (!confirm("Team wirklich zur√ºcksetzen? (Spielstand wird gel√∂scht)")) return;

    pushHistory(team);

    team.players = [];
    team.turn.currentPlayerIndex = 0;
    team.turn.round = 1;
    team.ended = false;
    team.history = [];

    gameSubTab = "turn";
    pfSelectIndex = 0;

    persist();
    activeTab = "opt";
    renderAll();
  }

  function doDeleteTeam(id){
    const team = getTeamById(id);
    if (!team) return;
    if (!confirm(`Team "${team.teamName}" wirklich l√∂schen?`)) return;

    teams = teams.filter(t => t.teamId !== id);
    persist();

    if (activeTeamId === id){
      activeTeamId = null;
      document.getElementById("viewTeam").style.display = "none";
    }
    renderAll();
  }

  function doDeleteAllTeams(){
    if (!teams.length) return alert("Keine Teams vorhanden.");
    if (!confirm("Wirklich ALLE Teams l√∂schen?")) return;
    teams = [];
    persist();
    activeTeamId = null;
    document.getElementById("viewTeam").style.display = "none";
    renderAll();
  }

  function doPflichtSelect(team){
    const sel = document.getElementById("pflichtPlayerSelect");
    if (!sel) return;
    const idx = Number(sel.value);
    if (!Number.isFinite(idx)) return;
    pfSelectIndex = idx;
    gameSubTab = "pflicht";
    renderAll();
  }

  function doPflichtFail(team){
    if (team.ended) return;
    const p = team.players[pfSelectIndex];
    if (!p) return;

    if (p.pfDone) return alert("Pflicht ist f√ºr diesen Spieler bereits abgeschlossen.");

    pushHistory(team);

    p.pfAttempts = (p.pfAttempts||0) + 1;
    p.pfFails = (p.pfFails||0) + 1;
    ensurePfAutoDone(p);

    persist();
    gameSubTab = "pflicht";
    renderAll();
  }

  function doPflichtSuccess(team){
    if (team.ended) return;
    const p = team.players[pfSelectIndex];
    if (!p) return;

    if (p.pfDone) return alert("Pflicht ist f√ºr diesen Spieler bereits abgeschlossen.");

    pushHistory(team);

    p.pfAttempts = (p.pfAttempts||0) + 1;
    p.pfDone = true;
    p.pfSuccess = true;

    persist();
    gameSubTab = "pflicht";
    renderAll();
  }

  function doPflichtReset(team){
    const p = team.players[pfSelectIndex];
    if (!p) return;

    if (!confirm(`Pflicht f√ºr ${p.name} wirklich zur√ºcksetzen? (Versuche/Fehlkosten werden gel√∂scht)`)) return;

    pushHistory(team);

    p.pfAttempts = 0;
    p.pfFails = 0;
    p.pfDone = false;
    p.pfSuccess = false;

    persist();
    gameSubTab = "pflicht";
    renderAll();
  }

  /** =======================
   *  Event Wiring
   *  ======================= */
  // Create Team
  document.getElementById("createTeamBtn").addEventListener("click", () => {
    const name = document.getElementById("teamName").value;
    if (!name.trim()) return alert("Bitte Teamname eingeben.");

    const t = defaultTeam(name);
    teams.unshift(t);
    persist();

    document.getElementById("teamName").value = "";
    setActiveTeam(t.teamId);
    activeTab = "opt";
    renderAll();
  });

  // Top tabs
  document.getElementById("tabDashboard").addEventListener("click", () => { activeTab="dash"; renderAll(); });
  document.getElementById("tabGame").addEventListener("click",      () => { activeTab="game"; renderAll(); });
  document.getElementById("tabOptions").addEventListener("click",   () => { activeTab="opt";  renderAll(); });

  // Delete all teams
  document.getElementById("deleteAllTeamsBtn").addEventListener("click", doDeleteAllTeams);

  // Delegated clicks for dynamic buttons
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-action]");
    if (!btn) return;

    const action = btn.getAttribute("data-action");
    const team = getActiveTeam();

    if (action === "openTeam"){
      const id = btn.getAttribute("data-id");
      setActiveTeam(id);
      activeTab = "dash";
      renderAll();
      return;
    }

    if (action === "deleteTeam"){
      const id = btn.getAttribute("data-id");
      doDeleteTeam(id);
      return;
    }

    // From here: needs active team
    if (!team) return;

    switch(action){
      case "endGame": doEndGame(team); break;
      case "undo": doUndo(team); break;
      case "setSubTab":
        gameSubTab = btn.getAttribute("data-sub") === "pflicht" ? "pflicht" : "turn";
        if (gameSubTab === "pflicht") pfSelectIndex = team.turn.currentPlayerIndex;
        renderAll();
        break;
      case "nextTurn": doNextTurn(team); break;
      case "savePlayers": doSavePlayers(team); break;
      case "saveConfig": doSaveConfig(team); break;
      case "resetTeam": doResetTeam(team); break;

      case "pflichtFail": doPflichtFail(team); break;
      case "pflichtSuccess": doPflichtSuccess(team); break;
      case "pflichtReset": doPflichtReset(team); break;
    }
  });

  // Delegated change for Pflicht select
  document.addEventListener("change", (e) => {
    if (e.target && e.target.id === "pflichtPlayerSelect"){
      const team = getActiveTeam();
      if (!team) return;
      doPflichtSelect(team);
    }
  });

  // Initial render
  renderAll();

})();
</script>
</body>
</html>